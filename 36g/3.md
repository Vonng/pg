# 名正言顺：模式设计 问题集锦



主键设计：UUID

主键设计：业务语义

主键设计：发号器



数据库类型：UUID

数据类型：JSON



## 0x02 设计规范

> Suum cuique

【强制】 **字符编码必须为UTF8**

* 禁止使用其他任何字符编码。



【强制】 **容量规划**

- 单表记录过亿，或超过10GB的量级，可以考虑开始进行分表。
- 单表容量超过1T，单库容量超过2T。需要考虑分片。



【强制】 **不要滥用存储过程**

* 存储过程适用于封装事务，减少并发冲突，减少网络往返，减少返回数据量，执行**少量**自定义逻辑。
* 存储过程**不适合**进行复杂计算，不适合进行平凡/频繁的类型转换与包装。



【强制】 **存储计算分离**

* 移除数据库中**不必要**的计算密集型逻辑，例如在数据库中使用SQL进行WGS84到其他坐标系的换算。
* 例外：与数据获取、筛选密切关联的计算逻辑允许在数据库中进行，如PostGIS中的几何关系判断。



【强制】 **主键与身份列**

* 每个表都必须有**身份列**，原则上必须有主键，最低要求为拥有**非空唯一约束**。
* 身份列用于唯一标识表中的任一元组，逻辑复制与诸多三方工具有赖于此。



【强制】 **外键**

* 不建议使用外键，建议在应用层解决。使用外键时，引用必须设置相应的动作：`SET NULL`, `SET DEFAULT`, `CASCADE`，慎用级联操作。



【强制】 **慎用宽表**

* 字段数目超过15个的表视作宽表，宽表应当考虑进行纵向拆分，通过相同的主键与主表相互引用。
* 因为MVCC机制，宽表的写放大现象比较明显，尽量减少对宽表的频繁更新。



【强制】 **配置合适的默认值**

* 有默认值的列必须添加`DEFAULT`子句指定默认值。
* 可以在默认值中使用函数，动态生成默认值（例如主键发号器）。



【强制】 **合理应对空值**

- 字段语义上没有零值与空值区分的，不允许空值存在，须为列配置`NOT NULL`约束。


【强制】 **唯一约束通过数据库强制**。

* 唯一约束须由数据库保证，任何唯一列须有唯一约束。
* `EXCLUDE`约束是泛化的唯一约束，可以在低频更新场景下用于保证数据完整性。



【强制】 **注意整数溢出风险**

* 注意SQL标准不提供无符号整型，超过`INTMAX`但没超过`UINTMAX`的值需要升格存储。
* 不要存储超过`INT64MAX`的值到`BIGINT`列中，会溢出为负数。



【强制】 **统一时区**

* 使用`TIMESTAMP`存储时间，采用`utc`时区。
* 统一使用ISO-8601格式输入输出时间类型：`2006-01-02 15:04:05`，避免DMY与MDY问题。
* 使用`TIMESTAMPTZ`时，采用GMT/UTC时间，0时区标准时。



【强制】 **及时清理过时函数**

- 不再使用的，被替换的函数应当及时下线，避免与未来的函数发生冲突。



【推荐】 **主键类型**

- 主键通常使用整型，建议使用`BIGINT`，允许使用不超过64字节的字符串。
- 主键允许使用`Serial`自动生成，建议使用`Default next_id()`发号器函数。



【推荐】 **选择合适的类型**

* 能使用专有类型的，不使用字符串。（数值，枚举，网络地址，货币，JSON，UUID等）
* 使用正确的数据类型，能显著提高数据存储，查询，索引，计算的效率，并提高可维护性。



【推荐】 **使用枚举类型**

* 较稳定的，取值空间较小（十几个内）的字段应当使用枚举类型，不要使用整型与字符串表示。
* 使用枚举类型有性能、存储、可维护性上的优势。



【推荐】 **选择合适的文本类型**

* PostgreSQL的文本类型包括 `char(n)`, `varchar(n)`, `text`。
* 通常建议使用`varchar`或`text`，带有`(n)`修饰符的类型会检查字符串长度，会导致微小的额外开销，对字符串长度有限制时应当使用`varchar(n)`，避免插入过长的脏数据。
* 避免使用`char(n)`，为了与SQL标准兼容，该类型存在不合直觉的行为表现（补齐空格与截断），且并没有存储和性能优势。



【推荐】 **选择合适的数值类型**

* 常规数值字段使用`INTEGER`。主键、容量拿不准的数值列使用`BIGINT`。
* 无特殊理由不要用`SMALLINT`，性能与存储提升很小，会有很多额外的问题。
* `REAL`表示4字节浮点数，`FLOAT`表示8字节浮点数
* 浮点数仅可用于末尾精度无所谓的场景，例如地理坐标，不要对浮点数使用等值判断。
* 精确数值类型使用`NUMERIC`，注意精度和小数位数设置。
* 货币数值类型使用`MONEY`。



【推荐】 **使用统一的函数创建语法**

- 签名单独占用一行（函数名与参数），返回值单启一行，语言为第一个标签。
- 一定要标注函数易变性等级：`IMMUTABLE`, `STABLE`, `VOLATILE`。
- 添加确定的属性标签，如：`RETURNS NULL ON NULL INPUT`,`PARALLEL SAFE`,`ROWS 1`，注意版本兼容性。

```sql
CREATE OR REPLACE FUNCTION
  nspname.myfunc(arg1_ TEXT, arg2_ INTEGER)
  RETURNS VOID
LANGUAGE SQL
STABLE
PARALLEL SAFE
ROWS 1
RETURNS NULL ON NULL INPUT
AS $function$
SELECT 1;
$function$;
```



【推荐】 **针对可演化性而设计**

* 在设计表时，应当充分考虑未来的扩展需求，可以在建表时适当添加1~3个保留字段。
* 对于多变的非关键字段可以使用JSON类型。



【推荐】 **选择合理的规范化等级**

- 允许适当降低规范化等级，减少多表连接以提高性能。



【推荐】 **使用新版本**

- 新版本有无成本的性能提升，稳定性提升，有更多新功能。
- 充分利用新特性，降低设计复杂度。



【推荐】 **慎用触发器**

* 触发器会提高系统的复杂度与维护成本，不鼓励使用。

